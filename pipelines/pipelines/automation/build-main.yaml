#
# Copyright contributors to the Galasa project 
# 
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: main-automation
  namespace: galasa-pipelines
spec:
  workspaces:
  - name: git-workspace
  params:
  - name: pull-request-number
    type: string
  tasks:
  # - name: retag-image
  # need to create new task for this
  # pass in commit-sha as paramater
  # find kaniko commands to retag image from commit sha > main
  - name: retag-ghgverify
    taskRef:
      name: retag-image
    params:
    - name: pipelineRunName
      value: $(context.pipelineRun.name)  
    - name: prImageName
      value: harbor.galasa.dev/common/ghg-verify:$(params.pull-request-number)
    - name: mainImageName
      value: harbor.galasa.dev/common/ghg-verify:main
    workspaces:
    - name: git-workspace
      workspace: git-workspace 
  - name: retag-ghgstatus
    taskRef:
      name: retag-image
    params:
    - name: pipelineRunName
      value: $(context.pipelineRun.name)  
    - name: prImageName
      value: harbor.galasa.dev/common/ghg-status:$(params.pull-request-number)
    - name: mainImageName
      value: harbor.galasa.dev/common/ghgstatus:main
    workspaces:
    - name: git-workspace
      workspace: git-workspace 
  - name: retag-gpg
    taskRef:
      name: retag-image
    params:
    - name: pipelineRunName
      value: $(context.pipelineRun.name)  
    - name: prImageName
      value: harbor.galasa.dev/common/gpg:$(params.pull-request-number)
    - name: mainImageName
      value: harbor.galasa.dev/common/gpg:main
    workspaces:
    - name: git-workspace
      workspace: git-workspace    
  - name: retag-kubectl
    taskRef:
      name: retag-image
    params:
    - name: pipelineRunName
      value: $(context.pipelineRun.name)  
    - name: prImageName
      value: harbor.galasa.dev/common/kubectl:$(params.pull-request-number)
    - name: mainImageName
      value: harbor.galasa.dev/common/kubectl:main
    workspaces:
    - name: git-workspace
      workspace: git-workspace     

  # research Deployment objects and how they create the maven artifact repositories
  # check if the recycle-deployment step is needed for the automation main build, as don't think we deploy any maven artifacts for it? 

  # - name: recycle-deployment
  #   taskRef: 
  #     name: recycle-deployment
  #   params:
  #   - name: namespace
  #     value: galasa-pipelines
  #   - name: deployment
  #     value: automation
  #   workspaces:
  #    - name: output
  #      workspace: git-workspace