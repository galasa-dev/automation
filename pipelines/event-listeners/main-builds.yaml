#
# Copyright contributors to the Galasa project 
# 
apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: github-main-builder-listener
spec:
  serviceAccountName: tekton-trigger
  triggers:
    - name: gitlab-push-events-trigger
      interceptors:
        - name: "validate GitHub payload and filter on eventType"
          ref:
            name: "github"
          params:
          - name: "secretRef"
            value:
              secretName: github-token
              secretKey: token
          - name: "eventTypes"
            value: ["push"]
        - name: "CEL filter: only when pushed to main"
          ref:
            name: "cel"
          params:
          - name: "filter"
            value: "body.ref in ['refs/heads/main']"

      bindings:
        - name: git-repository-name
          value: $(body.repository.name)
       
      template:
        spec:
          params:
            - name: git-repository-name
          resourcetemplates:
            - apiVersion: tekton.dev/v1beta1
              kind: PipelineRun
              metadata:
                generateName: repo-$(tt.params.git-repository-name)-main-
              spec:
                pipelineRef:
                  name: main-$(tt.params.git-repository-name)
                serviceAccountName: build-bot
                podTemplate:
                  volumes:
                  - name: gradle-properties
                    secret:
                      secretName: gradle-properties
                  - name: gpgkey
                    secret:
                      secretName: gpgkey
                  - name: mavengpg
                    secret:
                      secretName: mavengpg
                workspaces:
                - name: git-workspace
                  persistentVolumeClaim:
                    claimName: tekton-build-workspace-pvc