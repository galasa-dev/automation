apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: github-pr-review-builder-listener
  namespace: galasa-pipelines
spec:
  serviceAccountName: tekton-trigger
  triggers:
    - name: gitlab-push-events-trigger
      interceptors:
        - name: "validate GitHub payload and filter on eventType"
          ref:
            name: "github"
          params:
          - name: "secretRef"
            value:
              secretName: github-token
              secretKey: token
          - name: "eventTypes"
            value: ["pull_request_review"]
        - name: "CEL filter: when comments are submitted"
          ref:
            name: "cel"
          params:
          - name: "filter"
            value: "body.action in ['submitted']"
        - name: "CEL filter: When commented the rebuild phrase"
          ref:
            name: "cel"
          params:
          - name: "filter"
            value: "body.review.body in ['Approved for building', 'approved for building']"
      bindings:
        - name: git-repository-name
          value: $(body.pull_request.head.repo.name)
        - name: git-pull-request-url
          value: $(body.pull_request.url)
      template:
        spec:
          params:
            - name: git-repository-name
            - name: git-pull-request-url
          resourcetemplates:
            - apiVersion: tekton.dev/v1beta1
              kind: PipelineRun
              metadata:
                generateName: show-parameter-triggered-pipeline-$(params.git-revision)-
              spec:
                pipelineRef:
                  name: pr-$(tt.params.git-repository-name)
                params:
                  - name: prUrl
                    value: pr-$(tt.params.git-pull-request-url)